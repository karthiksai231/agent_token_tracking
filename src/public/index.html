<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Spend â€” LLM Cost Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:       #F7F8FC;
  --white:    #FFFFFF;
  --text:     #0F172A;
  --text2:    #475569;
  --text3:    #94A3B8;
  --border:   rgba(0,0,0,0.07);
  --border2:  rgba(0,0,0,0.12);

  --indigo: #6366F1; --violet: #8B5CF6; --purple: #A855F7;
  --teal:   #14B8A6; --cyan:   #06B6D4; --emerald:#10B981;
  --amber:  #F59E0B; --orange: #F97316; --rose:   #F43F5E;
  --blue:   #3B82F6; --pink:   #EC4899;

  --g-main:   linear-gradient(135deg,#6366F1,#8B5CF6);
  --g-teal:   linear-gradient(135deg,#14B8A6,#06B6D4);
  --g-warm:   linear-gradient(135deg,#F59E0B,#F97316);
  --g-green:  linear-gradient(135deg,#10B981,#14B8A6);
  --g-rose:   linear-gradient(135deg,#F43F5E,#EC4899);
  --g-blue:   linear-gradient(135deg,#3B82F6,#6366F1);

  --shadow-xs: 0 1px 3px rgba(0,0,0,0.05);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.10);

  --r: 16px; --r-sm: 10px; --r-xs: 6px;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  --mono: 'SF Mono','Cascadia Code','Fira Code',monospace;
}

body {
  font-family: var(--font); background: var(--bg); color: var(--text);
  line-height: 1.6; min-height: 100vh; overflow-x: hidden;
}

/* Mesh background */
body::before {
  content: ''; position: fixed; inset: 0; height: 700px;
  background:
    radial-gradient(ellipse 80% 50% at 0% 0%,   rgba(99,102,241,.10) 0%, transparent 55%),
    radial-gradient(ellipse 60% 50% at 100% 5%,  rgba(139,92,246,.07) 0%, transparent 50%),
    radial-gradient(ellipse 50% 40% at 50% 25%,  rgba(20,184,166,.05) 0%, transparent 50%);
  pointer-events: none; z-index: 0;
}

/* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-wrap { max-width: 1240px; margin: 0 auto; padding: 36px 28px 80px; position: relative; z-index: 1; }

/* â”€â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes fadeUp { from { opacity:0; transform:translateY(18px); } to { opacity:1; transform:translateY(0); } }
@keyframes spin   { to { transform:rotate(360deg); } }
@keyframes countUp { from { opacity:0; } to { opacity:1; } }
.fade { animation: fadeUp .45s ease both; }
.d1 { animation-delay:.05s; } .d2 { animation-delay:.10s; } .d3 { animation-delay:.15s; }
.d4 { animation-delay:.20s; } .d5 { animation-delay:.25s; } .d6 { animation-delay:.30s; }

/* â”€â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loading {
  display:flex; align-items:center; justify-content:center;
  min-height:100vh; flex-direction:column; gap:18px;
}
.spinner { width:34px; height:34px; border:3px solid var(--border2); border-top-color:var(--indigo); border-radius:50%; animation:spin .7s linear infinite; }
.loading-txt { color:var(--text2); font-size:15px; font-weight:500; }
#dashboard { display:none; }

/* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  display:flex; align-items:center; justify-content:space-between;
  flex-wrap:wrap; gap:14px; margin-bottom:36px;
}
.header-left { display:flex; align-items:center; gap:12px; }
.logo-mark {
  width:40px; height:40px; border-radius:12px; background:var(--g-main);
  display:flex; align-items:center; justify-content:center;
  box-shadow: 0 4px 14px rgba(99,102,241,.35);
  flex-shrink:0;
}
.logo-mark svg { width:22px; height:22px; }
.header-title { font-size:21px; font-weight:800; letter-spacing:-.5px; }
.header-sub   { font-size:13px; color:var(--text3); font-weight:500; margin-top:1px; }
.header-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

/* range pills */
.range-pills { display:flex; gap:4px; background:var(--white); padding:3px; border-radius:22px; border:1px solid var(--border); }
.range-pill {
  padding:5px 14px; border-radius:18px; border:none; background:transparent;
  color:var(--text2); font-size:13px; font-weight:500; cursor:pointer; font-family:var(--font);
  transition:all .15s;
}
.range-pill.active { background:var(--indigo); color:#fff; box-shadow:0 2px 8px rgba(99,102,241,.3); }
.range-pill:not(.active):hover { background:rgba(99,102,241,.08); color:var(--indigo); }

.refresh-btn {
  display:flex; align-items:center; gap:7px;
  background:var(--white); border:1px solid var(--border2); color:var(--text2);
  padding:7px 16px; border-radius:22px; cursor:pointer; font-size:13px;
  font-weight:500; font-family:var(--font); transition:all .2s;
}
.refresh-btn:hover { border-color:var(--indigo); color:var(--indigo); box-shadow:0 2px 10px rgba(99,102,241,.15); }
.refresh-btn svg { width:14px; height:14px; transition:transform .4s; }
.refresh-btn.spinning svg { animation:spin .7s linear infinite; }

/* â”€â”€â”€ Stat Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid {
  display:grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap:12px; margin-bottom:24px;
}
@media (max-width:960px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width:560px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }

.stat-card {
  background:var(--white); border-radius:var(--r); padding:18px 16px;
  border:1px solid var(--border); box-shadow:var(--shadow-xs);
  position:relative; overflow:hidden; transition:box-shadow .2s, transform .2s;
  min-width:0;
}
.stat-card:hover { box-shadow:var(--shadow-md); transform:translateY(-1px); }
.stat-card .bar { position:absolute; top:0; left:0; right:0; height:3px; border-radius:var(--r) var(--r) 0 0; }
.stat-label { font-size:10px; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:.05em; margin-bottom:8px; line-height:1.3; }
.stat-value { font-size:clamp(18px, 2vw, 28px); font-weight:800; letter-spacing:-1px; line-height:1.1; color:var(--text); margin-bottom:5px; word-break:break-all; }
.stat-sub   { font-size:11px; color:var(--text3); font-weight:500; line-height:1.4; }
.stat-sub .up   { color:var(--rose); }
.stat-sub .down { color:var(--emerald); }
.stat-badge { display:inline-flex; align-items:center; gap:4px; font-size:11px; font-weight:600; padding:2px 8px; border-radius:10px; }
.badge-savings  { background:rgba(16,185,129,.12); color:var(--emerald); }
.badge-cached   { background:rgba(99,102,241,.10); color:var(--indigo); }

/* â”€â”€â”€ Charts Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts-row {
  display:grid; grid-template-columns:3fr 2fr;
  gap:16px; margin-bottom:20px;
}
@media (max-width:860px) { .charts-row { grid-template-columns:1fr; } }

.chart-card {
  background:var(--white); border:1px solid var(--border); border-radius:var(--r);
  padding:22px; box-shadow:var(--shadow-xs);
}
.chart-card-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:18px; gap:12px; }
.chart-card-title  { font-size:15px; font-weight:700; color:var(--text); }
.chart-card-sub    { font-size:12px; color:var(--text3); margin-top:2px; }

/* SVG line chart */
#line-chart-wrap { position:relative; }
#line-chart { width:100%; overflow:visible; }
.axis-label { font-size:10px; fill:#94A3B8; font-family:var(--font); }
.grid-line { stroke:#E2E8F0; stroke-width:1; }
.chart-line { fill:none; stroke:url(#lineGrad); stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; }
.chart-area { fill:url(#areaGrad); }
.dot { fill:var(--white); stroke:var(--indigo); stroke-width:2.5; cursor:pointer; transition:r .15s; }
.dot:hover { r:5; }

/* Tooltip */
.chart-tip {
  position:absolute; background:var(--text); color:#F8FAFC;
  padding:8px 12px; border-radius:9px; font-size:12px; font-weight:500;
  pointer-events:none; white-space:nowrap; opacity:0; transition:opacity .15s;
  box-shadow:0 4px 16px rgba(0,0,0,.2);
}
.chart-tip::after { content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:5px solid transparent; border-top-color:var(--text); }

/* Donut */
.donut-wrap { display:flex; flex-direction:column; align-items:center; justify-content:center; }
.charts-row .chart-card:last-child { align-self: start; }
.donut-svg  { overflow:visible; width:100%; max-width:260px; }
.donut-center-label { font-size:16px; font-weight:800; fill:var(--text); font-family:var(--font); }
.donut-center-sub   { font-size:10px; fill:var(--text3); font-family:var(--font); }
.legend { display:flex; flex-direction:column; gap:7px; width:100%; margin-top:16px; }
.legend-row { display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; }
.legend-left { display:flex; align-items:center; gap:8px; color:var(--text2); min-width:0; }
.legend-dot  { width:9px; height:9px; border-radius:50%; flex-shrink:0; }
.legend-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px; }
.legend-val  { font-weight:700; color:var(--text); white-space:nowrap; }
.legend-pct  { color:var(--text3); font-size:11px; min-width:36px; text-align:right; }

/* â”€â”€â”€ Insights Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.insights-section { margin:24px 0; }
.insights-section > h2 {
  font:600 13px/1 var(--font); letter-spacing:.06em; text-transform:uppercase;
  color:var(--text3); margin-bottom:14px;
}
.insights-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:14px;
}
@media(max-width:860px){ .insights-grid{ grid-template-columns:repeat(2,1fr); } }
@media(max-width:520px){ .insights-grid{ grid-template-columns:1fr; } }

.insight-card {
  background:var(--white); border:1px solid var(--border); border-radius:var(--r-sm);
  padding:16px; display:flex; flex-direction:column; gap:10px;
}
.insight-card.ic-positive { border-left:3px solid #22c55e; }
.insight-card.ic-warning  { border-left:3px solid #f59e0b; }
.insight-card.ic-danger   { border-left:3px solid #ef4444; }
.insight-card.ic-neutral  { border-left:3px solid #6366f1; }

.ic-header { display:flex; align-items:center; gap:8px; }
.ic-icon   { font-size:18px; line-height:1; flex-shrink:0; }
.ic-title  { font:600 13px/1 var(--font); color:var(--text); }
.ic-badge  { margin-left:auto; font:600 10px/1 var(--font); padding:2px 7px; border-radius:20px; white-space:nowrap; flex-shrink:0; }
.ic-badge.ic-positive { background:#dcfce7; color:#15803d; }
.ic-badge.ic-warning  { background:#fef3c7; color:#b45309; }
.ic-badge.ic-danger   { background:#fee2e2; color:#b91c1c; }
.ic-badge.ic-neutral  { background:#e0e7ff; color:#4338ca; }

.ic-metric { font:700 22px/1 var(--font); color:var(--text); }
.ic-desc   { font:400 12px/1.5 var(--font); color:var(--text3); }
.ic-action {
  font:500 12px/1.5 var(--font); color:var(--text2);
  background:var(--bg); border-radius:var(--r-xs);
  padding:8px 10px; border-left:2px solid var(--border2);
}

/* â”€â”€â”€ Section headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.section-title  { font-size:15px; font-weight:700; }
.section-sub    { font-size:12px; color:var(--text3); }

/* â”€â”€â”€ Model table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.model-table-card {
  background:var(--white); border:1px solid var(--border); border-radius:var(--r);
  padding:22px; box-shadow:var(--shadow-xs); overflow:hidden; margin-bottom:20px;
}
.model-table-card table { width:100%; border-collapse:collapse; font-size:12px; }
.model-table-card th {
  padding:7px 10px; text-align:left; font-size:10px; font-weight:600;
  text-transform:uppercase; letter-spacing:.06em; color:var(--text3);
  border-bottom:1px solid var(--border); white-space:nowrap;
}
.model-table-card td { padding:10px 10px; border-bottom:1px solid var(--border); vertical-align:middle; }
.model-table-card tr:last-child td { border-bottom:none; }
.model-table-card tr:hover td { background:rgba(99,102,241,.03); }
.model-name { font-family:var(--mono); font-size:11px; font-weight:600; color:var(--text); }
.badge-provider {
  display:inline-block; padding:2px 8px; border-radius:10px; font-size:10px;
  font-weight:700; text-transform:uppercase; letter-spacing:.04em;
}
.bp-anthropic { background:rgba(217,119,6,.12); color:#92400E; }
.bp-openai    { background:rgba(16,163,127,.12); color:#065F46; }
.bp-unknown   { background:rgba(99,102,241,.12); color:#3730A3; }
.num { text-align:right; font-weight:600; color:var(--text2); }
.cost-num { text-align:right; font-weight:700; color:var(--text); }
.mini-bar-wrap { display:flex; align-items:center; gap:8px; }
.mini-bar { height:5px; border-radius:3px; min-width:4px; }

/* â”€â”€â”€ Tab bar + explorer card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-bar { display:flex; gap:4px; margin-bottom:20px; background:var(--white); padding:4px; border-radius:10px; border:1px solid var(--border); width:fit-content; }
.tab-btn { padding:6px 18px; border:none; background:transparent; border-radius:7px; cursor:pointer; font-size:13px; font-weight:500; color:var(--text2); font-family:var(--font); transition:all .15s; }
.tab-btn.active { background:var(--indigo); color:#fff; box-shadow:0 2px 8px rgba(99,102,241,.3); }
.tab-btn:not(.active):hover { background:rgba(99,102,241,.07); color:var(--indigo); }
.tab-content { display:none; }
.tab-content.active { display:block; }

/* Explorer card (used for Sessions tab) */
.explorer-card {
  background:var(--white); border:1px solid var(--border); border-radius:var(--r);
  padding:22px; box-shadow:var(--shadow-xs); overflow-x:auto;
}
.filters { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:14px; }
.filters select, .filters input[type=date] {
  background:var(--bg); border:1px solid var(--border2); border-radius:var(--r-xs);
  padding:6px 10px; font-size:12px; color:var(--text); font-family:var(--font);
  outline:none; transition:border-color .15s;
}
.filters select:focus, .filters input:focus { border-color:var(--indigo); }
.btn { padding:6px 14px; border-radius:var(--r-xs); border:none; cursor:pointer; font-size:12px; font-weight:600; font-family:var(--font); transition:all .15s; }
.btn-primary { background:var(--indigo); color:#fff; }
.btn-primary:hover { opacity:.87; }
.btn-ghost { background:transparent; color:var(--text2); border:1px solid var(--border2); }
.btn-ghost:hover { border-color:var(--indigo); color:var(--indigo); }

.ex-table { width:100%; border-collapse:collapse; font-size:12px; }
.ex-table th { padding:7px 10px; text-align:left; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.06em; color:var(--text3); border-bottom:1px solid var(--border); white-space:nowrap; }
.ex-table td { padding:9px 10px; border-bottom:1px solid var(--border); }
.ex-table tr:last-child td { border-bottom:none; }
.ex-table tr:hover td { background:rgba(99,102,241,.025); }
.pagination { display:flex; align-items:center; gap:8px; margin-top:12px; font-size:12px; color:var(--text3); }
.pagination button { padding:4px 10px; background:var(--white); border:1px solid var(--border2); border-radius:6px; cursor:pointer; font-size:12px; color:var(--text); transition:border-color .15s; }
.pagination button:hover { border-color:var(--indigo); color:var(--indigo); }
.pagination button:disabled { opacity:.4; cursor:default; }

/* â”€â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer { text-align:center; padding:24px; font-size:12px; color:var(--text3); margin-top:8px; }
footer a { color:var(--indigo); text-decoration:none; }
footer code { font-family:var(--mono); background:var(--bg); padding:1px 5px; border-radius:4px; }

/* â”€â”€â”€ Misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mono { font-family:var(--mono); }
.right { text-align:right; }
.empty-state { text-align:center; padding:40px 20px; color:var(--text3); font-size:14px; }
.sr-only { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); }

/* scrollbar */
::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:3px; }

/* â”€â”€â”€ Stat card help tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stat-help {
  display:inline-flex; align-items:center; justify-content:center;
  width:14px; height:14px; border-radius:50%;
  background:rgba(99,102,241,.12); color:var(--indigo);
  font-size:9px; font-weight:700; cursor:help;
  vertical-align:middle; margin-left:4px; line-height:1;
  text-transform:none; letter-spacing:0;
}

/* â”€â”€â”€ Expandable insight cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ic-expand-btn {
  align-self:flex-start; background:none; border:none; cursor:pointer;
  font:500 11px/1 var(--font); color:var(--text3); padding:0;
  display:flex; align-items:center; gap:4px; margin-top:2px;
}
.ic-expand-btn::after { content:' â–¾'; transition:transform .2s; display:inline-block; }
.ic-expand-btn.open::after { transform:rotate(180deg); }
.ic-detail {
  display:none; font:400 11px/1.6 var(--font); color:var(--text2);
  border-top:1px solid var(--border); padding-top:10px; margin-top:4px;
}
.ic-detail.open { display:block; }

/* â”€â”€â”€ Expensive session rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.row-expensive td { background:rgba(244,63,94,.03); }
.row-expensive .cost-per-req { color:var(--rose); font-weight:700; }
/* â”€â”€ Expensive prompts collapsible â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ep-toggle-btn {
  background:none; border:1px solid var(--border); cursor:pointer;
  font:500 10px/1 var(--font); color:var(--text3); padding:2px 7px;
  border-radius:4px; display:inline-flex; align-items:center; gap:4px;
  transition:background .15s, color .15s; white-space:nowrap;
}
.ep-toggle-btn:hover { background:rgba(99,102,241,.07); color:var(--indigo); border-color:var(--indigo); }
.ep-toggle-btn.open  { background:rgba(99,102,241,.08); color:var(--indigo); border-color:var(--indigo); }
.ep-toggle-btn .ep-chevron { font-size:9px; transition:transform .2s; display:inline-block; }
.ep-toggle-btn.open .ep-chevron { transform:rotate(180deg); }
.ep-prompt-row td { padding:0 12px 10px 28px; border-top:none; }
.ep-prompt-box {
  font:400 12px/1.6 var(--mono);
  color:var(--text2);
  background:rgba(15,23,42,.025);
  border:1px solid var(--border);
  border-left:3px solid rgba(99,102,241,.4);
  padding:10px 14px;
  border-radius:0 6px 6px 0;
  white-space:pre-wrap;
  word-break:break-word;
  max-height:200px;
  overflow-y:auto;
}
.ep-row-with-prompt td:first-child { border-bottom: none; }
.ep-prompt-row { display:none; }
.ep-prompt-row.open { display:table-row; }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <div class="loading-txt">Loading your LLM spend dataâ€¦</div>
</div>

<div id="dashboard" class="page-wrap">

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="header fade">
    <div class="header-left">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
      </div>
      <div>
        <div class="header-title">Claude Spend</div>
        <div class="header-sub" id="header-sub">Local LLM cost dashboard</div>
      </div>
    </div>
    <div class="header-right">
      <div class="range-pills">
        <button class="range-pill" data-days="1">Today</button>
        <button class="range-pill" data-days="7">7D</button>
        <button class="range-pill active" data-days="30">30D</button>
        <button class="range-pill" data-days="0">All</button>
      </div>
      <button class="refresh-btn" id="refresh-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
        Refresh
      </button>
    </div>
  </header>

  <!-- â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="tab-bar fade d1">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="sessions">Sessions</button>
  </div>

  <!-- â•â•â•â• TAB: OVERVIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-overview" class="tab-content active">

    <!-- Stat cards (4 cards) -->
    <div class="stats-grid">
      <div class="stat-card fade d1" id="card-cost">
        <div class="bar" style="background:var(--g-main)"></div>
        <div class="stat-label">Total Cost <span class="stat-help" title="Estimated USD cost for the selected period, calculated from token usage Ã— model pricing.">?</span></div>
        <div class="stat-value" id="s-cost">â€”</div>
        <div class="stat-sub" id="s-cost-sub">all time</div>
      </div>
      <div class="stat-card fade d2" id="card-req">
        <div class="bar" style="background:var(--g-teal)"></div>
        <div class="stat-label">Messages Sent <span class="stat-help" title="Total number of messages sent to the API (each assistant response = 1 message).">?</span></div>
        <div class="stat-value" id="s-req">â€”</div>
        <div class="stat-sub" id="s-req-sub">API calls tracked</div>
      </div>
      <div class="stat-card fade d3" id="card-tokens">
        <div class="bar" style="background:var(--g-blue)"></div>
        <div class="stat-label">Total Tokens <span class="stat-help" title="Sum of all tokens processed: input + output + cache creation + cache read tokens.">?</span></div>
        <div class="stat-value" id="s-tokens">â€”</div>
        <div class="stat-sub" id="s-tokens-sub">tokens processed</div>
      </div>
      <div class="stat-card fade d4" id="card-savings">
        <div class="bar" style="background:var(--g-green)"></div>
        <div class="stat-label">Cache Savings <span class="stat-help" title="Estimated dollars saved by prompt caching. Claude caches context and re-reads it at ~10% of normal input cost.">?</span></div>
        <div class="stat-value" id="s-savings">â€”</div>
        <div class="stat-sub" id="s-savings-sub"><span class="stat-badge badge-cached" id="s-cache-rate">â€”% hit rate</span></div>
      </div>
      <div class="stat-card fade d5" id="card-est">
        <div class="bar" style="background:var(--g-rose)"></div>
        <div class="stat-label">Avg / Day <span class="stat-help" title="Average daily spend across active days in the period. Monthly estimate assumes the same daily rate continues.">?</span></div>
        <div class="stat-value" id="s-daily">â€”</div>
        <div class="stat-sub" id="s-daily-sub">â†’ <span id="s-monthly-est">â€”</span>/mo est.</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-row fade d3">
      <div class="chart-card">
        <div class="chart-card-header">
          <div>
            <div class="chart-card-title">Daily Spend</div>
            <div class="chart-card-sub" id="chart-subtitle">Cost per day by model</div>
          </div>
          <div id="chart-legend-inline" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;"></div>
        </div>
        <div id="line-chart-wrap">
          <svg id="line-chart" height="200">
            <defs>
              <linearGradient id="lineGrad" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0%"   stop-color="#6366F1"/>
                <stop offset="100%" stop-color="#8B5CF6"/>
              </linearGradient>
              <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%"   stop-color="#6366F1" stop-opacity=".18"/>
                <stop offset="100%" stop-color="#6366F1" stop-opacity="0"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="chart-tip" id="chart-tip"></div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-card-header">
          <div>
            <div class="chart-card-title">Cost by Model</div>
            <div class="chart-card-sub">Spend distribution</div>
          </div>
        </div>
        <div class="donut-wrap">
          <svg class="donut-svg" id="donut-svg" viewBox="0 0 220 220"></svg>
          <div class="legend" id="donut-legend"></div>
        </div>
      </div>
    </div>

    <!-- Actionable Insights -->
    <section id="insights-section" class="insights-section fade d4">
      <h2>Actionable Insights</h2>
      <div class="insights-grid"></div>
    </section>

    <!-- Projects by Cost -->
    <div class="model-table-card fade d5" id="projects-section">
      <div class="section-header">
        <div class="section-title">Projects by Cost</div>
        <div class="section-sub" id="projects-sub"></div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Project</th>
            <th class="right">Sessions</th>
            <th class="right">Requests</th>
            <th class="right">Cost</th>
            <th class="right">Cost/Req</th>
            <th style="width:80px">Share</th>
          </tr>
        </thead>
        <tbody id="projects-tbody"></tbody>
      </table>
    </div>

    <!-- Model breakdown table (full-width) -->
    <div class="model-table-card fade d6">
      <div class="section-header">
        <div class="section-title">Model Breakdown</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Model</th>
            <th class="right">Req</th>
            <th class="right">Cost</th>
            <th style="width:80px">Share</th>
          </tr>
        </thead>
        <tbody id="model-tbody"></tbody>
      </table>
    </div>

    <!-- Top Requests by Cost -->
    <div class="model-table-card fade d6" id="expensive-section">
      <div class="section-header">
        <div class="section-title">Top Requests by Cost</div>
        <div class="section-sub">Most expensive individual API calls</div>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Model</th>
              <th>Project Â· Session</th>
              <th class="right">Input</th>
              <th class="right">Output</th>
              <th class="right">Cache Read</th>
              <th class="right">Cost</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="expensive-tbody"></tbody>
        </table>
      </div>
    </div>
  </div><!-- /tab-overview -->

  <!-- â•â•â•â• TAB: SESSIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-sessions" class="tab-content">
    <div class="explorer-card">
      <div class="filters">
        <input type="date" id="sess-from">
        <input type="date" id="sess-to">
        <button class="btn btn-primary" onclick="loadSessions()">Apply</button>
        <button class="btn btn-ghost"   onclick="clearEl('sess-from','sess-to');loadSessions()">Clear</button>
      </div>
      <table class="ex-table">
        <thead><tr>
          <th>Project</th>
          <th>Session</th>
          <th class="right">Requests</th>
          <th class="right">Input</th>
          <th class="right">Output</th>
          <th class="right">Cache Read</th>
          <th class="right">Cost</th>
          <th class="right">Cost/Req</th>
          <th>Duration</th>
        </tr></thead>
        <tbody id="sessions-tbody"></tbody>
      </table>
    </div>
  </div>

  <footer>
    Data dir: <code id="footer-dir">~/.claude</code> Â·
    Reads directly from <code>~/.claude/</code> Â· No database Â· No telemetry
  </footer>
</div><!-- /dashboard -->

<script>
'use strict';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Constants & helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const COLORS = ['#6366F1','#8B5CF6','#EC4899','#F59E0B','#10B981','#06B6D4','#F97316','#84cc16','#3B82F6','#F43F5E'];
const ICONS  = ['ðŸ”µ','ðŸŸ£','ðŸ©·','ðŸŸ¡','ðŸŸ¢','ðŸ©µ','ðŸŸ ','ðŸŸ¤','ðŸ’™','â¤ï¸'];

const fmt$  = v => { const n=+(v||0); if(n>=100) return '$'+n.toFixed(0); if(n>=1) return '$'+n.toFixed(2); if(n>=0.01) return '$'+n.toFixed(3); return '$'+n.toFixed(4); };
const fmtK  = v => { v=v||0; return v>=1e6?(v/1e6).toFixed(2)+'M':v>=1e3?(v/1e3).toFixed(1)+'K':String(v); };
const fmtKs = v => { v=v||0; return v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':String(v); };
const fmtDate = s => s?(s+'').slice(0,10):'â€”';
const fmtTime = s => s?(s+'').slice(0,19).replace('T',' '):'â€”';
const esc  = s => String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const dur  = (a,b) => { if(!a||!b) return 'â€”'; const m=Math.floor(Math.abs(new Date(b)-new Date(a))/60000),h=Math.floor(m/60); return h>0?`${h}h ${m%60}m`:m>0?`${m}m`:'<1m'; };

async function api(path) {
  const r = await fetch(path, { cache: 'no-store' });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function clearEl(...ids) { ids.forEach(id => { const el = document.getElementById(id); if(el) el.value=''; }); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Date-range state
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _days = 30;

function activeDates() {
  if (!_days) return {};
  const to   = new Date();
  const from = new Date(); from.setDate(from.getDate() - _days + 1);
  return {
    from: from.toISOString().slice(0,10),
    to:   to.toISOString().slice(0,10)
  };
}

function qs(extra={}) {
  const p = new URLSearchParams({ ...activeDates(), ...extra });
  return p.toString() ? '?'+p.toString() : '';
}

document.querySelectorAll('.range-pill').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.range-pill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    _days = +btn.dataset.days;
    loadOverview();
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const TAB_LOADERS = { overview: loadOverview, sessions: loadSessions };

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.getElementById('tab-'+tab).classList.add('active');
    TAB_LOADERS[tab]?.();
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Refresh button
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('refresh-btn').addEventListener('click', async () => {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  try {
    const r = await fetch('/api/refresh', { method:'POST' });
    const d = await r.json();
    if (d.eventsInserted > 0) console.log(`+${d.eventsInserted} events`);
    loadOverview();
  } catch(e) { console.error(e); }
  btn.classList.remove('spinning');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Overview
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadOverview() {
  try {
    // 1. Show loading state immediately
    const rangeLabel = _days === 0 ? 'All time'
                     : _days === 1 ? 'Today'
                     : `Last ${_days} days`;
    const dates = activeDates();
    const rangeDetail = dates.from && dates.to
      ? ` Â· ${dates.from.slice(5)} â€“ ${dates.to.slice(5)}`
      : '';
    document.getElementById('chart-subtitle').textContent = rangeLabel + rangeDetail;

    // 2. Clear charts to visually signal refresh
    const lc = document.getElementById('line-chart');
    if (lc) lc.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#CBD5E1" font-size="13" font-family="Inter">Refreshingâ€¦</text>';
    const ds = document.getElementById('donut-svg');
    if (ds) ds.innerHTML = '';

    // 3. Fetch and render
    const [ov, ts, sessions, projects, expensive] = await Promise.all([
      api('/api/overview' + qs()),
      api('/api/timeseries' + qs()),
      api('/api/sessions' + qs({ limit: 10 })),
      api('/api/projects' + qs()),
      api('/api/events' + qs({ sort: 'cost', limit: 15 })),
    ]);
    renderStats(ov.totals, ts);
    renderLineChart(ts);
    renderDonut(ov.byModel);
    renderInsightCards(ov.totals, ov.byModel, ts, sessions);
    renderProjectsTable(projects);
    renderModelTable(ov.byModel);
    renderExpensivePrompts(expensive);
  } catch(e) { console.error(e); }
}

// â”€â”€â”€ Stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const fmtTok = v => { v=+(v||0); if(v>=1e9) return (v/1e9).toFixed(1)+'B'; if(v>=1e6) return (v/1e6).toFixed(1)+'M'; if(v>=1e3) return (v/1e3).toFixed(0)+'K'; return String(Math.round(v)); };

function renderStats(t, ts) {
  if (!t) return;
  animCount('s-cost', t.cost_usd, v => fmt$(v));
  animCount('s-req',  t.total_requests, v => fmtKs(v));

  const totalTok = (t.input_tokens||0)+(t.output_tokens||0)+(t.cache_creation_tokens||0)+(t.cache_read_tokens||0);

  // Total tokens card
  animCount('s-tokens', totalTok, v => fmtTok(Math.round(v)));
  document.getElementById('s-tokens-sub').textContent =
    `${fmtTok(t.input_tokens||0)} in Â· ${fmtTok(t.output_tokens||0)} out`;

  // Cache savings
  const savings = (t.cache_read_tokens||0) / 1e6 * (15 - 1.5);
  animCount('s-savings', savings, v => fmt$(v));

  // Avg per day
  const dates = [...new Set((ts||[]).map(r => r.date))];
  const nDays = Math.max(dates.length, 1);
  const daily = (t.cost_usd||0) / nDays;
  animCount('s-daily', daily, v => fmt$(v));
  document.getElementById('s-monthly-est').textContent = fmt$(daily * 30);

  // Sub labels
  const range = _days > 0 ? `last ${_days} days` : 'all time';
  document.getElementById('s-cost-sub').textContent = range;
  document.getElementById('s-req-sub').textContent  = `${nDays} active day${nDays!==1?'s':''}`;

  const hitVal = (t.cache_read_tokens||0) / Math.max(totalTok,1) * 100;
  document.getElementById('s-savings-sub').innerHTML = `<span class="stat-badge badge-savings">â†“ ${hitVal.toFixed(0)}% cached</span>`;
}

function animCount(id, end, fmt) {
  const el = document.getElementById(id);
  if (!el) return;
  const start = 0, dur = 700, startTime = performance.now();
  function step(now) {
    const p = Math.min((now - startTime) / dur, 1);
    const ease = 1 - Math.pow(1 - p, 3);
    el.textContent = fmt(start + (end - start) * ease);
    if (p < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// â”€â”€â”€ Insight Cards (8 cards, expandable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderInsightCards(totals, byModel, ts, sessions) {
  const sec = document.getElementById('insights-section');
  if (!sec) return;
  const grid = sec.querySelector('.insights-grid');
  grid.innerHTML = '';

  const cards = [];

  // â”€â”€ 1. Cache Efficiency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const totalInput = (totals.input_tokens||0) + (totals.cache_read_tokens||0);
  const cacheRate  = totalInput > 0 ? (totals.cache_read_tokens||0) / totalInput : 0;
  const cachePct   = Math.round(cacheRate * 100);
  const savedUSD   = (totals.cache_read_tokens||0) / 1e6 * 2.7;
  let cType, cAction, cDetail;
  if (cachePct >= 70) {
    cType   = 'positive';
    cAction = `Excellent! ${cachePct}% of input served from cache, saving ~${fmt$(savedUSD)}.`;
    cDetail = `Prompt caching lets Claude store your system prompt and re-read it at ~10% of the normal token cost. At ${cachePct}% hit rate, you're paying ~${fmt$(savedUSD)} less than you would without caching. Keep system prompts static and start new sessions for the same project to maintain this.`;
  } else if (cachePct >= 30) {
    cType   = 'warning';
    cAction = `Cache hit rate is ${cachePct}%. Try keeping system prompts static and grouping related tasks in the same session.`;
    cDetail = `You're getting ${cachePct}% of input from cache, but there's room to improve. The key is keeping your system prompt identical between requests â€” even small changes bust the cache. Aim for a large, fixed system prompt with project context, and use the same session for related tasks.`;
  } else {
    cType   = 'danger';
    cAction = `Low cache rate (${cachePct}%). Add a large unchanging system prompt â€” Claude caches it automatically, cutting costs up to 90%.`;
    cDetail = `Only ${cachePct}% of your input tokens come from cache. This means you're paying full price for repeated context on almost every request. Structure your prompts with a comprehensive, static system prompt block (project background, coding standards, etc). Claude automatically caches it after 2+ uses.`;
  }
  cards.push({ icon:'ðŸ’¾', title:'Cache Efficiency', metric:`${cachePct}%`, desc:'of input tokens served from cache', action: cAction, detail: cDetail, type: cType });

  // â”€â”€ 2. Model Mix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const opusCost  = (byModel||[]).filter(m => m.model.includes('opus')).reduce((s,m) => s + m.cost_usd, 0);
  const opusPct   = (totals.cost_usd||0) > 0 ? Math.round(opusCost / totals.cost_usd * 100) : 0;
  const sonnetCost = (byModel||[]).filter(m => m.model.includes('sonnet')).reduce((s,m) => s + m.cost_usd, 0);
  let mType, mAction, mDetail;
  if (opusPct < 20) {
    mType   = 'positive';
    mAction = 'Good model distribution â€” Opus used selectively, cheaper models handling the volume.';
    mDetail = `Opus makes up only ${opusPct}% of your spend. You're using the right tool for the right job â€” saving the expensive model for tasks that genuinely need it. Sonnet handles most coding, analysis, and writing at ~1/5th the cost of Opus.`;
  } else if (opusPct < 60) {
    mType   = 'warning';
    mAction = `Opus is ${opusPct}% of spend (${fmt$(opusCost)}). Audit whether all those tasks need Opus â€” Sonnet handles most coding at 1/5th the cost.`;
    mDetail = `You're spending ${fmt$(opusCost)} on Opus-class models. For comparison, Sonnet would cost ~${fmt$(opusCost * 0.2)} for the same requests. Tasks like code editing, summarization, and Q&A rarely need Opus. Try adding "Use claude-sonnet" to your Claude Code settings for everyday tasks.`;
  } else {
    mType   = 'danger';
    mAction = `Opus dominates at ${opusPct}% of spend (${fmt$(opusCost)}). Shifting to Sonnet could save ~${fmt$(opusCost * 0.8)}/period.`;
    mDetail = `Opus is consuming ${opusPct}% of your budget. It's 5Ã— more expensive than Sonnet per token. Run \`claude config set model claude-sonnet-4-5\` to make Sonnet your default and only escalate to Opus for tasks requiring deep reasoning or complex architecture decisions.`;
  }
  cards.push({ icon:'ðŸ¤–', title:'Model Mix', metric:`${opusPct}% Opus`, desc:'of total spend on Opus-class models', action: mAction, detail: mDetail, type: mType });

  // â”€â”€ 3. Session Efficiency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const globalAvgCPR = (totals.total_requests||0) > 0 ? (totals.cost_usd||0) / totals.total_requests : 0;
  let seType, seMetric, seDesc, seAction, seDetail;
  if (sessions && sessions.length > 0) {
    const top    = sessions[0];
    const topCPR = top.requests > 0 ? top.cost_usd / top.requests : 0;
    const proj   = top.project_path ? top.project_path.split('/').slice(-1)[0] : 'Unknown';
    const sid    = top.session_id   ? 'â€¦' + top.session_id.slice(-6) : '?';
    const ratio  = globalAvgCPR > 0 ? topCPR / globalAvgCPR : 1;
    seMetric = fmt$(topCPR) + '/req';
    seDesc   = `costliest session (${esc(proj)} ${sid}) Â· ${top.requests} requests`;
    if (ratio > 3) {
      seType   = 'warning';
      seAction = `Session ${sid} costs ${fmt$(topCPR)}/req â€” ${ratio.toFixed(1)}Ã— your ${fmt$(globalAvgCPR)} average. Long context is compounding cost. Start a new session after completing a major task.`;
      seDetail = `As a session grows, every new request re-reads the entire conversation history. By request ${top.requests}, Claude is re-reading ${top.requests - 1} prior messages. That's why this session costs ${ratio.toFixed(1)}Ã— more per request than average. Starting fresh sessions for new tasks resets the context window.`;
    } else {
      seType   = 'positive';
      seAction = `Session cost efficiency looks healthy â€” top session at ${fmt$(topCPR)}/req vs ${fmt$(globalAvgCPR)} average.`;
      seDetail = `Your sessions aren't showing runaway context accumulation. The costliest session (${sid}) costs ${fmt$(topCPR)} per request, which is within ${ratio.toFixed(1)}Ã— of your ${fmt$(globalAvgCPR)} overall average. Context window growth isn't a problem for you right now.`;
    }
  } else {
    seType = 'neutral'; seMetric = 'â€”'; seDesc = 'no session data yet';
    seAction = 'No session data available for the selected period.';
    seDetail = 'Session efficiency measures cost-per-request for your top sessions vs your overall average. A high ratio indicates context window accumulation where later requests in a session are paying for the full conversation history.';
  }
  cards.push({ icon:'âš¡', title:'Session Efficiency', metric: seMetric, desc: seDesc, action: seAction, detail: seDetail, type: seType });

  // â”€â”€ 4. Context Accumulation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const marathonSessions = (sessions||[]).filter(s => s.requests >= 50);
  const marathonCount    = marathonSessions.length;
  let caType, caAction, caDetail;
  if (marathonCount === 0) {
    caType   = 'positive';
    caAction = 'No marathon sessions found â€” good discipline in keeping sessions focused.';
    caDetail = 'A "marathon session" has 50+ requests and is a major cost driver. With each new request, Claude re-reads the entire conversation history. Keeping sessions under ~30 requests prevents exponential context cost growth.';
  } else {
    const totalMarathonCost = marathonSessions.reduce((s,r)=>s+r.cost_usd, 0);
    caType   = 'warning';
    caAction = `${marathonCount} marathon session${marathonCount>1?'s':''} found (50+ requests, ${fmt$(totalMarathonCost)} total). Context compounds cost â€” break large tasks into new sessions.`;
    caDetail = `Sessions with 50+ requests are where context accumulation hurts most. Request #50 re-reads 49 prior messages; request #100 re-reads 99. The ${marathonCount} marathon session${marathonCount>1?'s you have':' you have'} may be costing 2â€“5Ã— more per request than a fresh session would. After finishing a major subtask, type /clear or start a new chat.`;
  }
  cards.push({ icon:'ðŸ“š', title:'Context Accumulation', metric:`${marathonCount} marathon${marathonCount!==1?'s':''}`, desc:'sessions with 50+ requests (top 10 by cost)', action: caAction, detail: caDetail, type: caType });

  // â”€â”€ 5. Spend Trajectory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const msDay   = 86400000;
  const now     = new Date();
  const cutPrev = new Date(now - 14*msDay).toISOString().slice(0,10);
  const cutMid  = new Date(now -  7*msDay).toISOString().slice(0,10);
  const cutNow  = now.toISOString().slice(0,10);
  const prev7   = (ts||[]).filter(r => r.date >= cutPrev && r.date < cutMid).reduce((s,r) => s + r.cost_usd, 0);
  const last7   = (ts||[]).filter(r => r.date >= cutMid  && r.date <= cutNow).reduce((s,r) => s + r.cost_usd, 0);
  let tType, tAction, tDetail, tMetric;
  if (prev7 > 0.0001) {
    const delta = Math.round((last7 - prev7) / prev7 * 100);
    tMetric = (delta >= 0 ? '+' : '') + delta + '%';
    if (delta <= -10) {
      tType   = 'positive';
      tAction = `Spend dropped ${Math.abs(delta)}% week-over-week (${fmt$(prev7)} â†’ ${fmt$(last7)}).`;
      tDetail = `Your spend decreased from ${fmt$(prev7)} (prev 7 days) to ${fmt$(last7)} (last 7 days). If this reflects a deliberate change like switching to Sonnet or improving caching, great work. If it's just lower activity, monitor that it doesn't spike back up.`;
    } else if (delta < 10) {
      tType   = 'neutral';
      tAction = `Spend is stable week-over-week (${fmt$(prev7)} â†’ ${fmt$(last7)}).`;
      tDetail = `Your weekly spend has been consistent at ~${fmt$((prev7+last7)/2)}/week. Stability is good for budgeting. At this rate you'd project ~${fmt$(last7 * 4.3)}/month.`;
    } else {
      tType   = 'warning';
      tAction = `Spend up ${delta}% WoW (${fmt$(prev7)} â†’ ${fmt$(last7)}). Check for new marathon sessions or Opus usage spike.`;
      tDetail = `Your spend jumped from ${fmt$(prev7)} to ${fmt$(last7)} week-over-week (+${delta}%). Check the Sessions tab for long-running sessions started this week, or look at the Model Mix card to see if Opus usage increased. A single deep research session can easily add ${fmt$(last7 - prev7)} in a week.`;
    }
  } else {
    tMetric = fmt$(last7);
    tType   = 'neutral';
    tAction = 'Not enough history to compare periods â€” check back after 2 weeks of usage.';
    tDetail = 'Spend trajectory compares the last 7 days vs the prior 7 days to detect growth trends. Come back after accumulating 2+ weeks of data for meaningful trend analysis.';
  }
  cards.push({ icon:'ðŸ“ˆ', title:'Spend Trajectory', metric: tMetric, desc:'last 7 days vs prior 7 days', action: tAction, detail: tDetail, type: tType });

  // â”€â”€ 6. Response Verbosity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const inTok    = totals.input_tokens||0;
  const outTok   = totals.output_tokens||0;
  const ratio    = inTok > 0 ? outTok / inTok : 0;
  const ratioStr = ratio.toFixed(2) + 'x';
  let rType, rAction, rDetail;
  if (ratio < 0.5) {
    rType   = 'positive';
    rAction = `Concise responses (${ratioStr} output/input). Low verbosity keeps output costs efficient.`;
    rDetail = `Output tokens cost 3â€“5Ã— more than input tokens on most Claude models. Your ${ratioStr} output/input ratio means responses are well-scoped. This is ideal for interactive coding sessions where you want targeted changes, not essays.`;
  } else if (ratio < 1.5) {
    rType   = 'neutral';
    rAction = `Output/input ratio is ${ratioStr}. Add "Be concise" to your system prompt if responses feel verbose.`;
    rDetail = `A ratio around 1.0 means Claude outputs roughly as many tokens as you put in â€” typical for conversational or coding use. If you're getting longer responses than you need, adding constraints like "respond in under 200 words" or "show only the changed lines" can meaningfully cut output costs.`;
  } else {
    rType   = 'warning';
    rAction = `High output ratio (${ratioStr}). Limit response length explicitly â€” "respond in 3 bullet points max" or "show only changed code".`;
    rDetail = `Output tokens at ${ratioStr}Ã— input is in the verbose range. Since output tokens cost ~5Ã— more than input, high verbosity compounds quickly. The most effective fix: add explicit length constraints to your system prompt. Claude follows instructions like "be extremely concise" very well.`;
  }
  cards.push({ icon:'ðŸ“', title:'Response Verbosity', metric: ratioStr, desc:'output tokens per input token', action: rAction, detail: rDetail, type: rType });

  // â”€â”€ 7. Monthly Projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const allDates  = [...new Set((ts||[]).map(r => r.date))].sort();
  const dayCount  = Math.max(allDates.length, 1);
  const allCost   = (ts||[]).reduce((s,r) => s + r.cost_usd, 0);
  const dailyAvg  = allCost / dayCount;
  const projected = dailyAvg * 30;
  let pType, pAction, pDetail;
  if (projected < 20) {
    pType   = 'positive';
    pAction = `On track for ~${fmt$(projected)}/month â€” well within typical developer budgets.`;
    pDetail = `Based on ${dayCount} active days averaging ${fmt$(dailyAvg)}/day, your monthly run rate is ~${fmt$(projected)}. Most devs running Claude Code for personal projects budget $20â€“50/month. You're well under that. Keep it up!`;
  } else if (projected < 100) {
    pType   = 'neutral';
    pAction = `Projected ~${fmt$(projected)}/month based on ${fmt$(dailyAvg)}/day average. Steady usage â€” watch for spikes.`;
    pDetail = `At ${fmt$(dailyAvg)}/day across ${dayCount} active days, you're tracking to ~${fmt$(projected)}/month. This is moderate usage. If a particularly active week hits, you could see ${fmt$(projected * 1.5)}/month. Setting a mental budget alert at ${fmt$(projected * 1.3)} would give you early warning.`;
  } else {
    pType   = 'warning';
    pAction = `Projected ~${fmt$(projected)}/month is high. Haiku + caching improvements could cut this by 60â€“80%.`;
    pDetail = `At ${fmt$(dailyAvg)}/day you're on track for ${fmt$(projected)}/month. The biggest levers: (1) Switch to Sonnet for non-critical tasks (~5Ã— cheaper than Opus), (2) Improve cache hit rate (up to 90% savings on repeated context), (3) Keep sessions short to reduce context accumulation. Combined, these could bring your bill to ~${fmt$(projected * 0.25)}/month.`;
  }
  cards.push({
    icon:'ðŸ“…', title:'Monthly Projection', metric:`~${fmt$(projected)}/mo`,
    desc:`based on ${dayCount}-day average of ${fmt$(dailyAvg)}/day`,
    action: pAction, detail: pDetail, type: pType
  });

  // â”€â”€ 8. Best Optimization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let boType, boIcon, boMetric, boDesc, boAction, boDetail;
  if (cachePct < 30) {
    boType   = 'danger';
    boIcon   = 'ðŸŽ¯';
    boMetric = 'Fix caching first';
    boDesc   = 'highest-ROI optimization available';
    boAction = `Cache rate is only ${cachePct}%. Adding a static system prompt could cut costs by up to 90% on repeated context â€” the single biggest lever you have.`;
    boDetail = `How to add caching: In your Claude Code project, create a CLAUDE.md file with your project context (tech stack, conventions, goals). Claude Code automatically includes this as a cached system prompt. With even ${fmt$(savedUSD)} already saved at ${cachePct}% cache rate, fixing this to 70%+ could save ${fmt$(savedUSD * 5)}/period.`;
  } else if (opusPct > 60) {
    boType   = 'warning';
    boIcon   = 'ðŸŽ¯';
    boMetric = 'Switch default model';
    boDesc   = 'highest-ROI optimization available';
    boAction = `Opus is ${opusPct}% of spend. Running \`claude config set model claude-sonnet-4-5\` as default could save ~${fmt$(opusCost * 0.8)}/period.`;
    boDetail = `Sonnet is 5Ã— cheaper than Opus and handles >90% of coding tasks just as well. For the remaining cases where you need deeper reasoning, you can explicitly request Opus in the conversation. Making Sonnet your default would save approximately ${fmt$(opusCost * 0.8)} based on current usage patterns.`;
  } else if (marathonCount > 0) {
    boType   = 'warning';
    boIcon   = 'ðŸŽ¯';
    boMetric = 'Shorten sessions';
    boDesc   = 'highest-ROI optimization available';
    const mCost = marathonSessions.reduce((s,r)=>s+r.cost_usd,0);
    boAction = `${marathonCount} marathon session${marathonCount>1?'s':''} found. Resetting context after major tasks could cut per-request cost by 2â€“5Ã—.`;
    boDetail = `Your ${marathonCount} marathon session${marathonCount>1?'s cost':' costs'} ${fmt$(mCost)} total. As sessions get long, every request pays for the full conversation history. Run \`/clear\` or start a new Claude Code session after finishing a major feature or bug fix. This is especially impactful for long debugging sessions.`;
  } else {
    boType   = 'positive';
    boIcon   = 'âœ…';
    boMetric = 'Well optimized!';
    boDesc   = 'no critical optimizations needed';
    boAction = 'Good cache rate, balanced model mix, and no marathon sessions. Focus on staying consistent.';
    boDetail = `You're hitting the key optimization targets: ${cachePct}% cache rate (â‰¥30%), ${opusPct}% Opus spend (<60%), and no marathon sessions. The main thing now is consistency â€” keep system prompts static to maintain cache efficiency, and don't let sessions run indefinitely.`;
  }
  cards.push({ icon: boIcon, title:'Best Optimization', metric: boMetric, desc: boDesc, action: boAction, detail: boDetail, type: boType });

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const BADGE_LABELS = { positive:'âœ“ Good', warning:'âš  Watch', danger:'âœ— Critical', neutral:'â„¹ Info' };
  grid.innerHTML = cards.map(c => `
    <div class="insight-card ic-${c.type}">
      <div class="ic-header">
        <span class="ic-icon">${c.icon}</span>
        <span class="ic-title">${c.title}</span>
        <span class="ic-badge ic-${c.type}">${BADGE_LABELS[c.type]}</span>
      </div>
      <div class="ic-metric">${c.metric}</div>
      <div class="ic-desc">${c.desc}</div>
      <div class="ic-action">${c.action}</div>
      <button class="ic-expand-btn">Why this matters</button>
      <div class="ic-detail">${c.detail}</div>
    </div>`).join('');

  // Expand/collapse toggle
  grid.querySelectorAll('.ic-expand-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const detail = btn.nextElementSibling;
      btn.classList.toggle('open');
      detail.classList.toggle('open');
      btn.textContent = btn.classList.contains('open') ? 'Show less' : 'Why this matters';
    });
  });
}

// â”€â”€â”€ Projects Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderProjectsTable(projects) {
  const el = document.getElementById('projects-tbody');
  if (!el) return;
  if (!projects?.length) {
    el.innerHTML = '<tr><td colspan="6" class="empty-state">No project data</td></tr>';
    return;
  }
  const total   = projects.reduce((s,r) => s + r.cost_usd, 0);
  const maxCost = Math.max(...projects.map(r => r.cost_usd), 0.001);
  el.innerHTML = projects.slice(0, 8).map((r, i) => {
    const parts = r.project_path.split('/').filter(Boolean);
    const name  = parts.length >= 2 ? parts.slice(-2).join('/') : r.project_path;
    const pct   = (r.cost_usd / maxCost * 100).toFixed(0);
    const share = total > 0 ? (r.cost_usd / total * 100).toFixed(0) : 0;
    const cpr   = r.requests > 0 ? fmt$(r.cost_usd / r.requests) : 'â€”';
    return `<tr>
      <td><span class="model-name" title="${esc(r.project_path)}">${esc(name)}</span></td>
      <td class="num">${r.sessions}</td>
      <td class="num">${fmtKs(r.requests)}</td>
      <td class="cost-num">${fmt$(r.cost_usd)}</td>
      <td class="num" style="color:var(--text3)">${cpr}</td>
      <td>
        <div class="mini-bar-wrap">
          <div class="mini-bar" style="width:${pct}%;background:${COLORS[i%COLORS.length]}"></div>
          <span style="font-size:10px;color:var(--text3)">${share}%</span>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€ Line Chart (SVG) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderLineChart(rows) {
  const svg     = document.getElementById('line-chart');
  const wrap    = document.getElementById('line-chart-wrap');
  const tip     = document.getElementById('chart-tip');
  const legendEl = document.getElementById('chart-legend-inline');

  if (!rows?.length) { svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#94A3B8" font-size="14" font-family="Inter">No data</text>'; return; }

  const W = wrap.offsetWidth || 580;
  const H = 200;
  const PL=48, PR=16, PT=10, PB=36;
  const cw = W - PL - PR;
  const ch = H - PT - PB;

  svg.setAttribute('width', W);
  svg.setAttribute('height', H);
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

  // Roll up by date (total across models for the main line)
  const dateMap = {};
  rows.forEach(r => { dateMap[r.date] = (dateMap[r.date]||0) + r.cost_usd; });
  const dates  = Object.keys(dateMap).sort();
  const values = dates.map(d => dateMap[d]);
  const maxVal = Math.max(...values, 0.001);

  // Per-model for legend
  const models = [...new Set(rows.map(r => r.model))];

  // Grid + axes
  let inner = `
    <defs>
      <linearGradient id="lineGrad" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#6366F1"/>
        <stop offset="100%" stop-color="#8B5CF6"/>
      </linearGradient>
      <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#6366F1" stop-opacity=".15"/>
        <stop offset="100%" stop-color="#6366F1" stop-opacity="0"/>
      </linearGradient>
    </defs>`;

  // Y grid
  for (let i=0; i<=4; i++) {
    const y = PT + ch - (i/4)*ch;
    const label = '$' + (maxVal * i/4).toFixed(maxVal < .01 ? 5 : maxVal < 1 ? 3 : 2);
    inner += `<line x1="${PL}" y1="${y}" x2="${W-PR}" y2="${y}" class="grid-line"/>`;
    inner += `<text x="${PL-6}" y="${y+4}" text-anchor="end" class="axis-label">${label}</text>`;
  }

  // X labels (show every Nth)
  const step = Math.max(1, Math.ceil(dates.length / 8));
  dates.forEach((d, i) => {
    if (i % step !== 0 && i !== dates.length-1) return;
    const x = PL + (i / Math.max(dates.length-1,1)) * cw;
    inner += `<text x="${x}" y="${H-6}" text-anchor="middle" class="axis-label">${d.slice(5)}</text>`;
  });

  // Build smooth path
  const pts = dates.map((d, i) => {
    const x = PL + (i / Math.max(dates.length-1,1)) * cw;
    const y = PT + ch - (values[i] / maxVal) * ch;
    return [x, y];
  });

  function catmull(pts) {
    if (pts.length === 1) return `M${pts[0][0]},${pts[0][1]}`;
    let d = `M${pts[0][0]},${pts[0][1]}`;
    for (let i=0; i<pts.length-1; i++) {
      const p0 = pts[Math.max(i-1,0)], p1=pts[i], p2=pts[i+1], p3=pts[Math.min(i+2,pts.length-1)];
      const cp1x = p1[0] + (p2[0]-p0[0])/6;
      const cp1y = p1[1] + (p2[1]-p0[1])/6;
      const cp2x = p2[0] - (p3[0]-p1[0])/6;
      const cp2y = p2[1] - (p3[1]-p1[1])/6;
      d += ` C${cp1x},${cp1y} ${cp2x},${cp2y} ${p2[0]},${p2[1]}`;
    }
    return d;
  }

  const linePath = catmull(pts);
  const areaPath = linePath + ` L${pts[pts.length-1][0]},${PT+ch} L${pts[0][0]},${PT+ch} Z`;

  inner += `<path d="${areaPath}" class="chart-area"/>`;
  inner += `<path d="${linePath}" class="chart-line"/>`;

  // Dots + invisible hover targets
  pts.forEach(([x,y], i) => {
    inner += `<circle cx="${x}" cy="${y}" r="3.5" class="dot" data-i="${i}"/>`;
    inner += `<rect x="${x-16}" y="${PT}" width="32" height="${ch}" fill="transparent" class="dot-zone" data-i="${i}" style="cursor:pointer"/>`;
  });

  svg.innerHTML = inner;

  // Tooltip events
  svg.querySelectorAll('.dot-zone').forEach(el => {
    el.addEventListener('mouseenter', ev => {
      const i = +el.dataset.i;
      tip.style.opacity = '1';
      tip.innerHTML = `<strong>${dates[i]}</strong><br>${fmt$(values[i])}`;
      const svgRect = svg.getBoundingClientRect();
      const wrapRect = wrap.getBoundingClientRect();
      const x = pts[i][0] * (svgRect.width / W);
      tip.style.left = (x - tip.offsetWidth/2 + svgRect.left - wrapRect.left) + 'px';
      tip.style.top  = (pts[i][1] * (svgRect.height / H) - 42 + svgRect.top - wrapRect.top) + 'px';
    });
    el.addEventListener('mouseleave', () => { tip.style.opacity='0'; });
  });

  // Inline legend
  legendEl.innerHTML = models.slice(0,5).map((m,i) => `
    <span style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3)">
      <span style="width:8px;height:8px;border-radius:50%;background:${COLORS[i%COLORS.length]};display:inline-block"></span>
      ${esc(m.replace('claude-','').replace('gpt-',''))}
    </span>`).join('');
}

// â”€â”€â”€ Donut Chart (SVG) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderDonut(byModel) {
  const svgEl  = document.getElementById('donut-svg');
  const legend = document.getElementById('donut-legend');
  if (!byModel?.length) { svgEl.innerHTML=''; legend.innerHTML=''; return; }

  const total = byModel.reduce((s,r)=>s+r.cost_usd,0);
  const cx=110, cy=110, R=92, thick=30;
  const ir = R - thick;

  let angle = -Math.PI/2;
  let paths = '';

  byModel.forEach((r,i) => {
    const frac  = total > 0 ? r.cost_usd/total : 1/byModel.length;
    const sweep = frac * 2 * Math.PI;
    const col = COLORS[i%COLORS.length];

    // SVG arcs can't draw a full 360Â° circle (start === end point) â€” use circles instead
    if (sweep >= 2 * Math.PI - 0.001) {
      paths += `<circle cx="${cx}" cy="${cy}" r="${R}" fill="${col}" stroke="white" stroke-width="1.5"
        style="cursor:pointer;transition:opacity .15s" onmouseenter="this.style.opacity='.75'" onmouseleave="this.style.opacity='1'">
        <title>${esc(r.model)}: ${fmt$(r.cost_usd)} (100%)</title></circle>`;
      paths += `<circle cx="${cx}" cy="${cy}" r="${ir}" fill="white" pointer-events="none"/>`;
    } else {
      const x1 = cx + R*Math.cos(angle), y1 = cy + R*Math.sin(angle);
      const x2 = cx + R*Math.cos(angle+sweep), y2 = cy + R*Math.sin(angle+sweep);
      const xi1= cx + ir*Math.cos(angle+sweep), yi1 = cy + ir*Math.sin(angle+sweep);
      const xi2= cx + ir*Math.cos(angle), yi2 = cy + ir*Math.sin(angle);
      const large = sweep > Math.PI ? 1 : 0;
      paths += `<path d="M${x1},${y1} A${R},${R} 0 ${large},1 ${x2},${y2} L${xi1},${yi1} A${ir},${ir} 0 ${large},0 ${xi2},${yi2} Z"
        fill="${col}" stroke="white" stroke-width="2.5"
        style="cursor:pointer;transition:opacity .15s" onmouseenter="this.style.opacity='.75'" onmouseleave="this.style.opacity='1'">
        <title>${esc(r.model)}: ${fmt$(r.cost_usd)} (${total>0?(r.cost_usd/total*100).toFixed(1):'0'}%)</title>
      </path>`;
    }
    angle += sweep;
  });

  paths += `<text x="${cx}" y="${cy-7}" text-anchor="middle" class="donut-center-label">${fmt$(total)}</text>`;
  paths += `<text x="${cx}" y="${cy+14}" text-anchor="middle" class="donut-center-sub">total</text>`;
  svgEl.innerHTML = paths;

  legend.innerHTML = byModel.map((r,i) => `
    <div class="legend-row">
      <div class="legend-left">
        <div class="legend-dot" style="background:${COLORS[i%COLORS.length]}"></div>
        <span class="legend-name" title="${esc(r.model)}">${esc(r.model.replace(/claude-/,'').replace(/gpt-/,''))}</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="legend-val">${fmt$(r.cost_usd)}</span>
        <span class="legend-pct">${total>0?(r.cost_usd/total*100).toFixed(1):0}%</span>
      </div>
    </div>`).join('');
}

// â”€â”€â”€ Model Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderModelTable(byModel) {
  const el = document.getElementById('model-tbody');
  if (!byModel?.length) { el.innerHTML='<tr><td colspan="4" class="empty-state">No data</td></tr>'; return; }
  const maxCost = Math.max(...byModel.map(r=>r.cost_usd), 0.001);
  const total   = byModel.reduce((s,r)=>s+r.cost_usd,0);
  el.innerHTML = byModel.map((r,i) => {
    const pct = (r.cost_usd/maxCost*100).toFixed(0);
    const col = COLORS[i%COLORS.length];
    return `<tr>
      <td><span class="model-name">${esc(r.model)}</span><br>
        <span class="badge-provider bp-${r.provider||'unknown'}">${r.provider||'?'}</span>
      </td>
      <td class="num">${fmtKs(r.requests)}</td>
      <td class="cost-num">${fmt$(r.cost_usd)}</td>
      <td>
        <div class="mini-bar-wrap">
          <div class="mini-bar" style="width:${pct}%;background:${col}"></div>
          <span style="font-size:10px;color:var(--text3)">${total>0?(r.cost_usd/total*100).toFixed(0):'0'}%</span>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€ Expensive Prompts Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderExpensivePrompts(data) {
  const el = document.getElementById('expensive-tbody');
  if (!el) return;
  const rows = data?.rows || [];
  if (!rows.length) {
    el.innerHTML = '<tr><td colspan="8" class="empty-state">No data for this period</td></tr>';
    return;
  }
  el.innerHTML = rows.map((r, i) => {
    const proj    = r.project_path ? r.project_path.split('/').slice(-1)[0] : 'â€”';
    const sid     = r.session_id   ? 'â€¦' + r.session_id.slice(-5) : '';
    const model   = (r.model||'â€”').replace(/claude-/,'').replace(/gpt-/,'');
    const time    = r.occurred_at  ? r.occurred_at.slice(5, 16).replace('T', ' ') : 'â€”';
    const hasPrompt = !!r.prompt_text;
    const rowId   = `ep-prompt-${i}`;
    const toggleBtn = hasPrompt
      ? `<button class="ep-toggle-btn" onclick="toggleEpRow(this,'${rowId}')" aria-expanded="false">
           <span class="ep-chevron">â–¾</span> Prompt
         </button>`
      : '<span style="color:var(--text3);font-size:10px">â€”</span>';
    const promptRow = hasPrompt
      ? `<tr class="ep-prompt-row" id="${rowId}">
           <td colspan="8"><div class="ep-prompt-box">${esc(r.prompt_text)}</div></td>
         </tr>`
      : '';
    return `<tr class="${hasPrompt ? 'ep-row-with-prompt' : ''}">
      <td style="font-size:11px;color:var(--text3);white-space:nowrap">${time}</td>
      <td><span class="model-name" style="font-size:10px">${esc(model)}</span></td>
      <td style="font-size:11px;color:var(--text2)">
        ${esc(proj)}<span style="color:var(--text3);font-family:var(--mono);font-size:10px"> ${sid}</span>
      </td>
      <td class="num">${fmtK(r.input_tokens||0)}</td>
      <td class="num">${fmtK(r.output_tokens||0)}</td>
      <td class="num">${fmtK(r.cache_read_tokens||0)}</td>
      <td class="cost-num">${fmt$(r.cost_usd)}</td>
      <td style="text-align:right;white-space:nowrap">${toggleBtn}</td>
    </tr>${promptRow}`;
  }).join('');

}

function toggleEpRow(btn, rowId) {
  const promptRow = document.getElementById(rowId);
  if (!promptRow) return;
  const isOpen = promptRow.classList.toggle('open');
  btn.classList.toggle('open', isOpen);
  btn.setAttribute('aria-expanded', isOpen);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Sessions tab
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadSessions() {
  const tbody = document.getElementById('sessions-tbody');
  tbody.innerHTML = '<tr><td colspan="9" class="empty-state">Loadingâ€¦</td></tr>';
  const from = document.getElementById('sess-from').value;
  const to   = document.getElementById('sess-to').value;
  const p = new URLSearchParams({ limit:50 });
  if (from) p.set('from',from); if (to) p.set('to',to);
  try {
    const rows = await api('/api/sessions?'+p);
    if (!rows.length) { tbody.innerHTML='<tr><td colspan="9" class="empty-state">No sessions</td></tr>'; return; }
    const totalCost     = rows.reduce((s,r) => s + r.cost_usd, 0);
    const totalRequests = rows.reduce((s,r) => s + r.requests, 0);
    const globalAvg     = totalRequests > 0 ? totalCost / totalRequests : 0;
    tbody.innerHTML = rows.map(r => {
      const proj       = r.project_path ? r.project_path.split('/').slice(-2).join('/') : 'â€”';
      const cpr        = r.requests > 0 ? r.cost_usd / r.requests : 0;
      const cprStr     = r.requests > 0 ? fmt$(cpr) : 'â€”';
      const isExpensive = globalAvg > 0 && cpr > globalAvg * 3;
      return `<tr class="${isExpensive ? 'row-expensive' : ''}">
        <td>${esc(proj)}</td>
        <td class="mono" style="font-size:11px;color:var(--text3)">${esc((r.session_id||'').slice(0,10))}â€¦</td>
        <td class="num">${r.requests}</td>
        <td class="num">${fmtK(r.input_tokens)}</td>
        <td class="num">${fmtK(r.output_tokens)}</td>
        <td class="num">${fmtK(r.cache_read_tokens)}</td>
        <td class="cost-num">${fmt$(r.cost_usd)}</td>
        <td class="num cost-per-req">${cprStr}</td>
        <td style="color:var(--text3);font-size:12px">${dur(r.started_at,r.ended_at)}</td>
      </tr>`;
    }).join('');
  } catch(e) { tbody.innerHTML=`<tr><td colspan="9" class="empty-state">Error: ${esc(e.message)}</td></tr>`; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Boot
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(async function init() {
  // Set greeting
  const hr = new Date().getHours();
  const greet = hr<12?'Good morning':hr<17?'Good afternoon':'Good evening';
  document.getElementById('header-sub').textContent = greet + ' â€” here\'s your LLM spend summary';

  // Set footer data dir
  try {
    const s = await api('/api/settings');
    const dir = s.claude_data_dir || '~/.claude';
    document.getElementById('footer-dir').textContent = dir;
  } catch {}

  await loadOverview();

  document.getElementById('loading').style.display   = 'none';
  document.getElementById('dashboard').style.display = 'block';
})();
</script>
</body>
</html>
